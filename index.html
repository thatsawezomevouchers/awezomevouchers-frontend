<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Awezome Vacation Vouchers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Segoe UI, Arial;
      background: #f4f6f8;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 640px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(20, 20, 20, 0.08);
    }
    h1 {
      margin: 0 0 10px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }
    input,
    select,
    button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd7de;
      font-size: 15px;
    }
    #priceDisplay {
      margin-top: 14px;
      font-weight: 700;
      text-align: center;
    }
    button {
      background: #0070f3;
      color: white;
      border: 0;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Awezome Vacation Vouchers</h1>

    <label for="search">Search (country or city)</label>
    <input id="search" placeholder="Start typing country or city name..." />

    <label for="country">Country / Region</label>
    <select id="country">
      <option value="">Select Country / Region</option>
    </select>

    <label for="city">City / Destination</label>
    <select id="city">
      <option value="">Select Destination</option>
    </select>

    <label for="promo">Promo code (optional)</label>
    <input id="promo" placeholder="Enter promo code" />

    <div id="priceDisplay">Voucher Price: $0</div>

    <button id="payBtn">Pay with Card / Apple Pay</button>
    <p style="margin-top:10px;font-size:13px;color:#666;">
      If Apple Pay doesn't appear on your device, customers can also pay via your external channels.
    </p>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // ===== CONFIG =====
    const STRIPE_PUBLISHABLE_KEY = "pk_test_51SpY0o4fSKyDUsuM29eSoNNbBb3AGRt4dZ4Z5rhg4geejvy78Wk3Sto6nYHhEwNukCjMhn1ql4fs1T7tQ5Q89J7dd2bD8";
    const backendURL = "https://awezomevouchers-backend.vercel.app"; // âœ… FIXED

    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    // ===== Promo pricing logic =====
    function computeClientPrice(country, city, promo) {
      let base = 75;
      if (
        country === "Special Vouchers" ||
        country === "Cruise Destinations" ||
        country === "Cruise Vacations"
      )
        base = 100;

      if (!promo) return base;
      const p = promo.trim().toLowerCase();
      if (p === "thats50" && base === 75) return 50;
      if (p === "thats75" && base === 100) return 75;
      if (p === "thatsfamily") return Math.round(base * 0.5);
      return base;
    }

    // ===== DOM Elements =====
    const countrySelect = document.getElementById("country");
    const citySelect = document.getElementById("city");
    const promoInput = document.getElementById("promo");
    const priceDisplay = document.getElementById("priceDisplay");
    const searchBox = document.getElementById("search");
    const payBtn = document.getElementById("payBtn");

    // ===== Destinations =====
    const destinations = {
      "Belgium": ["Brussels (4 Days, 3 Nights)"],
      "Brazil": ["Rio de Janeiro (5 Days, 4 Nights)"],
      "France": ["Paris (5 Days, 4 Nights)"],
      "United States": ["New York (4 Days, 3 Nights)", "Miami (4 Days, 3 Nights)"],
      "Australia": ["Sydney (5 Days, 4 Nights)", "Melbourne (4 Days, 3 Nights)"]
    };

    function populateCountryList(filterFn) {
      const keys = Object.keys(destinations).sort((a, b) => a.localeCompare(b));
      countrySelect.innerHTML = '<option value="">Select Country / Region</option>';
      keys.forEach((country) => {
        if (!filterFn || filterFn(country)) {
          const o = document.createElement("option");
          o.value = country;
          o.textContent = country;
          countrySelect.appendChild(o);
        }
      });
    }

    function populateCityList(country) {
      citySelect.innerHTML = '<option value="">Select Destination</option>';
      if (!country) return;
      const cities = destinations[country] || [];
      cities.forEach((c) => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        citySelect.appendChild(o);
      });
    }

    populateCountryList();

    function updateDisplayedPrice() {
      const country = countrySelect.value;
      const city = citySelect.value;
      const promo = promoInput.value.trim();
      const price = computeClientPrice(country, city, promo);
      priceDisplay.textContent = `Voucher Price: $${price}`;
    }

    countrySelect.addEventListener("change", () => {
      populateCityList(countrySelect.value);
      updateDisplayedPrice();
    });
    citySelect.addEventListener("change", updateDisplayedPrice);
    promoInput.addEventListener("input", updateDisplayedPrice);

    payBtn.addEventListener("click", async () => {
      payBtn.disabled = true;

      const country = countrySelect.value;
      const city = citySelect.value;
      const promo = promoInput.value.trim();

      if (!country) {
        alert("Please choose a country/region.");
        payBtn.disabled = false;
        return;
      }
      if (!city) {
        alert("Please choose a destination.");
        payBtn.disabled = false;
        return;
      }

      try {
        const price = computeClientPrice(country, city, promo);
        const response = await fetch(`${backendURL}/create-checkout-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            price,
            name: `${country} - ${city}`,
            email: "none@none.com",
            phone: "N/A",
          }),
        });

        const json = await response.json();
        if (!response.ok) {
          alert("Backend error: " + (json.error || "unknown"));
          payBtn.disabled = false;
          return;
        }

        const { sessionId } = json;
        await stripe.redirectToCheckout({ sessionId });
      } catch (err) {
        console.error(err);
        alert("Network error contacting backend.");
        payBtn.disabled = false;
      }
    });

    updateDisplayedPrice();
  </script>
</body>
</html>
