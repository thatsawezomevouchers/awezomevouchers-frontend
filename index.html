<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Awezome Vacation Vouchers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#f4f6f8;padding:24px;display:flex;justify-content:center}
    .card{width:100%;max-width:640px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,20,.08)}
    h1{margin:0 0 10px}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #d0d7de;font-size:15px}
    #priceDisplay{margin-top:14px;font-weight:700;text-align:center}
    button{background:#0070f3;color:#fff;border:0;padding:12px}
    button:disabled{opacity:.5}
    p.note{margin-top:10px;font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h1>Awezome Vacation Vouchers</h1>

    <label for="search">Search (country or city)</label>
    <input id="search" placeholder="Start typing country or city name..." />

    <label for="country">Country / Region</label>
    <select id="country"><option value="">Select Country / Region</option></select>

    <label for="city">City / Destination</label>
    <select id="city"><option value="">Select Destination</option></select>

    <label for="promo">Promo code (optional)</label>
    <input id="promo" placeholder="Enter promo code" />

    <label for="name">Full Name</label>
    <input id="name" placeholder="Enter your name" />

    <label for="email">Email</label>
    <input id="email" placeholder="Enter your email" />

    <label for="phone">Phone Number</label>
    <input id="phone" placeholder="Enter your phone number" />

    <div id="priceDisplay">Voucher Price: $0</div>

    <button id="payBtn">Pay with Card / Apple Pay</button>
    <p class="note">If Apple Pay doesn't appear, you can still pay via card checkout.</p>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
  const STRIPE_PUBLISHABLE_KEY = "pk_test_51SPYOdAfSKyDUssUW29eSSoNNNBb3A6RR4TdZ4Z3Srhg4Geejvy78Wk35to6nYHH6EwhUkxCjPMnlq14fsTI7QGS000j7dd2b8";
  const backendURL = "https://awezomevouchers-backend.vercel.app";

  const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

  const destinations = {
    "United States": ["New York (4 Days, 3 Nights)", "Miami (4 Days, 3 Nights)", "Los Angeles (4 Days, 3 Nights)", "Las Vegas (4 Days, 3 Nights)"],
    "France": ["Paris (5 Days, 4 Nights)"],
    "Japan": ["Tokyo (6 Days, 5 Nights)"],
    "Australia": ["Sydney (4 Days, 3 Nights)", "Melbourne (4 Days, 3 Nights)"],
    "Brazil": ["Rio de Janeiro (5 Days, 4 Nights)"],
  };

  const countrySelect = document.getElementById("country");
  const citySelect = document.getElementById("city");
  const searchBox = document.getElementById("search");
  const promoInput = document.getElementById("promo");
  const priceDisplay = document.getElementById("priceDisplay");
  const payBtn = document.getElementById("payBtn");

  function populateCountries() {
    countrySelect.innerHTML = "<option value=''>Select Country / Region</option>";
    Object.keys(destinations).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      countrySelect.appendChild(opt);
    });
  }

  function populateCities(country) {
    citySelect.innerHTML = "<option value=''>Select Destination</option>";
    if (destinations[country]) {
      destinations[country].forEach(city => {
        const opt = document.createElement("option");
        opt.value = city;
        opt.textContent = city;
        citySelect.appendChild(opt);
      });
    }
  }

  function computePrice(country) {
    let price = 75;
    if (country === "Special Vouchers") price = 100;
    return price;
  }

  function updatePrice() {
    const country = countrySelect.value;
    const price = computePrice(country);
    priceDisplay.textContent = `Voucher Price: $${price}`;
  }

  searchBox.addEventListener("input", (e) => {
    const q = e.target.value.toLowerCase();
    const matches = Object.keys(destinations).filter(c => 
      c.toLowerCase().includes(q) ||
      destinations[c].some(city => city.toLowerCase().includes(q))
    );
    countrySelect.innerHTML = "<option value=''>Select Country / Region</option>";
    matches.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      countrySelect.appendChild(opt);
    });
  });

  countrySelect.addEventListener("change", () => {
    populateCities(countrySelect.value);
    updatePrice();
  });
  citySelect.addEventListener("change", updatePrice);
  promoInput.addEventListener("input", updatePrice);

  populateCountries();
  updatePrice();

  payBtn.addEventListener("click", async () => {
    const country = countrySelect.value;
    const city = citySelect.value;
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const phone = document.getElementById("phone").value;
    if (!country || !city || !email) {
      alert("Please complete all required fields.");
      return;
    }
    payBtn.disabled = true;
    try {
      const response = await fetch(`${backendURL}/api/create-checkout-session`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({country, city, name, email, phone, price: computePrice(country)})
      });
      const data = await response.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert("Error: " + (data.error || "Unknown backend issue"));
      }
    } catch (err) {
      console.error(err);
      alert("Network error contacting backend.");
    }
    payBtn.disabled = false;
  });
  </script>
</body>
</html>
