<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Awezome Vacation Vouchers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#f4f6f8;padding:24px;display:flex;justify-content:center}
    .card{width:100%;max-width:760px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,20,.08)}
    h1{margin:0 0 10px}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #d0d7de;font-size:15px}
    #priceDisplay{margin-top:14px;font-weight:700;text-align:center}
    button{background:#0070f3;color:#fff;border:0;padding:12px}
    button:disabled{opacity:.5}
    p.note{margin-top:10px;font-size:13px;color:#666}
    .loading{opacity:0.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="card">
    <h1>Awezome Vacation Vouchers</h1>

    <label for="search">Search (country or city)</label>
    <input id="search" placeholder="Start typing country or city name..." />

    <label for="country">Country / Region</label>
    <select id="country"><option value="">Select Country / Region</option></select>

    <label for="city">City / Destination</label>
    <select id="city"><option value="">Select Destination</option></select>

    <label for="promo">Promo code (optional)</label>
    <input id="promo" placeholder="Enter promo code" />

    <label for="name">Full Name</label>
    <input id="name" placeholder="Enter your name" />

    <label for="email">Email</label>
    <input id="email" type="email" placeholder="Enter your email" />

    <label for="phone">Phone Number</label>
    <input id="phone" type="tel" placeholder="Enter your phone number" />

    <div id="priceDisplay">Voucher Price: $0</div>

    <button id="payBtn">Pay with Card / Apple Pay</button>
    <p class="note">If Apple Pay doesn't appear, you can still pay via card checkout.</p>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
  // UPDATE THIS to your backend domain if different
  const backendURL = "https://awezomevouchers-backend.vercel.app";

  // Replace with your publishable key (this can be public)
  const STRIPE_PUBLISHABLE_KEY = "pk_test_51SPYOdAfSKyDUssUW29eSSoNNNBb3A6RR4TdZ4Z3Srhg4Geejvy78Wk35to6nYHH6EwhUkxCjPMnlq14fsTI7QGS000j7dd2b8";
  const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

  // ---------- destinations (expanded list) ----------
  const destinations = {
    "United States": [
      "New York (4 Days, 3 Nights)",
      "Los Angeles (4 Days, 3 Nights)",
      "Miami (4 Days, 3 Nights)",
      "Las Vegas (4 Days, 3 Nights)",
      "San Francisco (4 Days, 3 Nights)",
      "Chicago (4 Days, 3 Nights)",
      "Orlando (4 Days, 3 Nights)"
    ],
    "Australia": [
      "Sydney (4 Days, 3 Nights)", 
      "Melbourne (4 Days, 3 Nights)",
      "Brisbane (4 Days, 3 Nights)"
    ],
    "Brazil": [
      "Rio de Janeiro (5 Days, 4 Nights)",
      "SÃ£o Paulo (4 Days, 3 Nights)"
    ],
    "France": [
      "Paris (5 Days, 4 Nights)",
      "Nice (4 Days, 3 Nights)"
    ],
    "Japan": [
      "Tokyo (6 Days, 5 Nights)",
      "Osaka (5 Days, 4 Nights)",
      "Kyoto (5 Days, 4 Nights)"
    ],
    "Italy": [
      "Rome (5 Days, 4 Nights)",
      "Venice (4 Days, 3 Nights)",
      "Florence (4 Days, 3 Nights)"
    ],
    "Spain": [
      "Barcelona (4 Days, 3 Nights)",
      "Madrid (4 Days, 3 Nights)"
    ],
    "Thailand": [
      "Bangkok (5 Days, 4 Nights)",
      "Phuket (5 Days, 4 Nights)"
    ],
    "Mexico": [
      "Cancun (5 Days, 4 Nights)",
      "Mexico City (4 Days, 3 Nights)"
    ],
    "Greece": [
      "Athens (4 Days, 3 Nights)",
      "Santorini (4 Days, 3 Nights)"
    ]
  };

  // Elements
  const countrySelect = document.getElementById("country");
  const citySelect = document.getElementById("city");
  const searchBox = document.getElementById("search");
  const promoInput = document.getElementById("promo");
  const priceDisplay = document.getElementById("priceDisplay");
  const payBtn = document.getElementById("payBtn");

  // populate countries
  function populateCountries(filterFn) {
    countrySelect.innerHTML = "<option value=''>Select Country / Region</option>";
    Object.keys(destinations).sort((a,b)=>a.localeCompare(b)).forEach(country=>{
      if (!filterFn || filterFn(country)) {
        const o = document.createElement("option");
        o.value = country; 
        o.textContent = country;
        countrySelect.appendChild(o);
      }
    });
  }

  // populate cities for a country
  function populateCities(country) {
    citySelect.innerHTML = "<option value=''>Select Destination</option>";
    if (!country) return;
    (destinations[country] || []).slice().sort((a,b)=>a.localeCompare(b)).forEach(c=>{
      const o = document.createElement("option");
      o.value = c; 
      o.textContent = c;
      citySelect.appendChild(o);
    });
  }

  // price logic (simple)
  function computePrice(country) {
    if (!country) return 0;
    let base = 75;
    // promo codes could reduce here
    const p = (promoInput.value || "").trim().toLowerCase();
    if (p === "thats50") return 50;
    if (p === "thats75") return 75;
    if (p === "save20") return 60;
    return base;
  }

  function updateDisplayedPrice() {
    const price = computePrice(countrySelect.value);
    priceDisplay.textContent = `Voucher Price: $${price}`;
  }

  // search logic: matches country OR city names
  searchBox.addEventListener("input", (e)=>{
    const q = (e.target.value || "").trim().toLowerCase();
    if (!q) {
      populateCountries();
      citySelect.innerHTML = "<option value=''>Select Destination</option>";
      return;
    }
    populateCountries(country=>{
      if (country.toLowerCase().includes(q)) return true;
      return destinations[country].some(city=>city.toLowerCase().includes(q));
    });
  });

  countrySelect.addEventListener("change", ()=>{
    populateCities(countrySelect.value);
    updateDisplayedPrice();
  });
  citySelect.addEventListener("change", updateDisplayedPrice);
  promoInput.addEventListener("input", updateDisplayedPrice);

  // init
  populateCountries();
  updateDisplayedPrice();

  // payment click
  payBtn.addEventListener("click", async ()=>{
    const country = countrySelect.value;
    const city = citySelect.value;
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const price = computePrice(country);

    if (!country || !city || !email) {
      alert("Please choose country, destination and enter an email.");
      return;
    }

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert("Please enter a valid email address.");
      return;
    }

    payBtn.disabled = true;
    payBtn.textContent = "Processing...";
    payBtn.classList.add('loading');

    try {
      const resp = await fetch(`${backendURL}/api/create-checkout-session`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ country, city, name, email, phone, price })
      });

      const data = await resp.json();
      
      if (!resp.ok) {
        console.error("Backend returned error:", data);
        alert("Error: " + (data.error || "Unable to process payment"));
        resetPayButton();
        return;
      }

      if (data.url) {
        // redirect to Stripe Checkout
        window.location.href = data.url;
      } else {
        alert("Unexpected response from server.");
        resetPayButton();
      }
    } catch (err) {
      console.error("Network error contacting backend:", err);
      alert("Network error. Please check your connection and try again.");
      resetPayButton();
    }
  });

  function resetPayButton() {
    payBtn.disabled = false;
    payBtn.textContent = "Pay with Card / Apple Pay";
    payBtn.classList.remove('loading');
  }
  </script>
</body>
</html>
