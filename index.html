<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Awezome Vacation Vouchers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #f6f6f6;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 640px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(20,20,20,0.08);
    }
    h1 { margin: 0 0 10px; text-align: center; }
    label { display:block; margin-top: 12px; font-weight:600; }
    input, select, button {
      width: 100%; padding: 10px;
      margin-top: 8px; border-radius: 6px;
      border: 1px solid #ddd7de; font-size: 15px;
    }
    button { background:#0070f3; color:white; border:0; }
    button:disabled { opacity: 0.6; }
    #priceDisplay { margin-top: 14px; font-weight: 700; text-align: center; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Awezome Vacation Vouchers</h1>

    <label for="search">Search (country or city)</label>
    <input id="search" placeholder="Start typing country or city name..." />

    <label for="country">Country / Region</label>
    <select id="country">
      <option value="">Select Country / Region</option>
    </select>

    <label for="city">City / Destination</label>
    <select id="city">
      <option value="">Select Destination</option>
    </select>

    <label for="promo">Promo code (optional)</label>
    <input id="promo" placeholder="Enter promo code" />

    <div id="priceDisplay">Voucher Price: $0</div>

    <button id="payBtn">Pay with Card / Apple Pay</button>
    <p style="margin-top:10px;font-size:13px;color:#666;">
      If Apple Pay doesn't appear on your device, customers can also pay via your external channels.
    </p>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const STRIPE_PUBLISHABLE_KEY = "pk_test_51SPy0XAfSy0uSdlW29eSoNbNbb3A6RRt4Td4Z3Srhg46eejyy78Wk3Sto6nYHH6EwHukcJPmh1q14fsTTj0C59E07dd2Db0B";
    const backendURL = "https://awezomevouchers-backend.vercel.app";
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    // Default pricing
    function computeClientPrice(country, city, promo) {
      let base = 75;
      if (country === "Special Vouchers" || country === "Cruise Destinations" || country === "Cruise Vacations") base = 100;
      if (!promo) return base;
      const p = promo.trim().toLowerCase();
      if (p === "thats50%" && base === 75) return 50;
      if (p === "thats75%" && base === 100) return 75;
      if (p === "thatsfamily") return Math.round(base * 0.5);
      return base;
    }

    const countrySelect = document.getElementById("country");
    const citySelect = document.getElementById("city");
    const promoInput = document.getElementById("promo");
    const priceDisplay = document.getElementById("priceDisplay");
    const searchBox = document.getElementById("search");
    const payBtn = document.getElementById("payBtn");

    // Full destinations list
    const destinations = {
      "Special Vouchers": ["7-Night Villa Voucher (8 Days, 7 Nights)", "3 Days, 2 Nights All-Inclusive Voucher (3 Days, 2 Nights)"],
      "Cruise Destinations": ["Cruise Vacation (3–14 Days Available)"],
      "Argentina": ["Buenos Aires (5 Days, 4 Nights)"],
      "Australia": ["Brisbane (4 Days, 3 Nights)", "Melbourne (4 Days, 3 Nights)", "Sydney (4 Days, 3 Nights)"],
      "Austria": ["Vienna (5 Days, 4 Nights)"],
      "Brazil": ["Rio de Janeiro (5 Days, 4 Nights)"],
      "Canada": ["Toronto (4 Days, 3 Nights)", "Vancouver (4 Days, 3 Nights)"],
      "China": ["Beijing (5 Days, 4 Nights)", "Macau (6 Days, 5 Nights)"],
      "Colombia": ["Cartagena (5 Days, 4 Nights)", "Medellín (5 Days, 4 Nights)"],
      "Dominican Republic": ["Punta Cana (5 Days, 4 Nights)", "Puerto Plata (6 Days, 5 Nights)"],
      "France": ["Paris (5 Days, 4 Nights)", "Cannes (4 Days, 3 Nights)"],
      "Germany": ["Berlin (4 Days, 3 Nights)", "Munich (5 Days, 4 Nights)"],
      "Greece": ["Athens (5 Days, 4 Nights)", "Santorini (6 Days, 5 Nights)"],
      "India": ["Goa (5 Days, 4 Nights)"],
      "Indonesia": ["Bali (5 Days, 4 Nights)"],
      "Italy": ["Rome (5 Days, 4 Nights)", "Venice (5 Days, 4 Nights)", "Amalfi Coast (5 Days, 4 Nights)"],
      "Japan": ["Kyoto (6 Days, 5 Nights)"],
      "Mexico": ["Cancun (6 Days, 5 Nights)", "Cabo San Lucas (5 Days, 4 Nights)"],
      "Portugal": ["Lisbon (5 Days, 4 Nights)"],
      "Spain": ["Barcelona (5 Days, 4 Nights)", "Madrid (5 Days, 4 Nights)"],
      "Thailand": ["Bangkok (5 Days, 4 Nights)", "Phuket (8 Days, 7 Nights)"],
      "Turkey": ["Istanbul (5 Days, 4 Nights)", "Bodrum (5 Days, 4 Nights)"],
      "United Kingdom": ["London (4 Days, 3 Nights)", "Edinburgh (4 Days, 3 Nights)"],
      "United States": [
        "New York (4 Days, 3 Nights)",
        "Miami (4 Days, 3 Nights)",
        "Las Vegas (4 Days, 3 Nights)",
        "Orlando (4 Days, 3 Nights)",
        "Los Angeles (4 Days, 3 Nights)",
        "Chicago (4 Days, 3 Nights)",
        "Hawaii (6 Days, 5 Nights)"
      ],
      "Vanuatu": ["Vanuatu (5 Days, 4 Nights)"]
    };

    // Populate countries
    function populateCountryList(filterFn) {
      const keys = Object.keys(destinations).sort((a, b) => a.localeCompare(b));
      countrySelect.innerHTML = `<option value="">Select Country / Region</option>`;
      keys.forEach(country => {
        if (!filterFn || filterFn(country)) {
          const o = document.createElement("option");
          o.value = country;
          o.textContent = country;
          countrySelect.appendChild(o);
        }
      });
    }

    // Populate cities
    function populateCityList(country) {
      citySelect.innerHTML = `<option value="">Select Destination</option>`;
      if (!country) return;
      const cities = destinations[country] || [];
      cities.sort((a, b) => a.localeCompare(b)).forEach(city => {
        const o = document.createElement("option");
        o.value = city;
        o.textContent = city;
        citySelect.appendChild(o);
      });
    }

    populateCountryList();

    function updateDisplayedPrice() {
      const country = countrySelect.value;
      const city = citySelect.value;
      const promo = promoInput.value.trim();
      const price = computeClientPrice(country, city, promo);
      priceDisplay.textContent = `Voucher Price: $${price}`;
    }

    // Search box logic
    searchBox.addEventListener("input", (e) => {
      const q = e.target.value.trim().toLowerCase();
      if (!q) return populateCountryList();
      populateCountryList(country => {
        if (country.toLowerCase().includes(q)) return true;
        return (destinations[country] || []).some(city => city.toLowerCase().includes(q));
      });
    });

    countrySelect.addEventListener("change", () => {
      populateCityList(countrySelect.value);
      updateDisplayedPrice();
    });

    citySelect.addEventListener("change", updateDisplayedPrice);
    promoInput.addEventListener("input", updateDisplayedPrice);

    payBtn.addEventListener("click", async () => {
      payBtn.disabled = true;
      const country = countrySelect.value;
      const city = citySelect.value;
      const promo = promoInput.value.trim();
      if (!country) return alert("Please choose a country/region."), payBtn.disabled = false;
      if (!city) return alert("Please choose a destination."), payBtn.disabled = false;

      const price = computeClientPrice(country, city, promo);

      try {
        const response = await fetch(`${backendURL}/api/create-checkout-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ price, country, city })
        });

        if (!response.ok) throw new Error(`Backend error: ${response.statusText}`);

        const json = await response.json();
        if (!json.sessionId) throw new Error("Missing session ID");

        const { error } = await stripe.redirectToCheckout({ sessionId: json.sessionId });
        if (error) alert(error.message);
      } catch (err) {
        console.error(err);
        alert("Network error contacting backend. Check console.");
      } finally {
        payBtn.disabled = false;
      }
    });

    updateDisplayedPrice();
  </script>
</body>
</html>
